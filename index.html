<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Walkie Debug (Canal 100-199)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#eee;padding:12px}
  .header{display:flex;gap:12px;align-items:center}
  #canal{font-size:1.6rem;padding:6px 10px;background:#222;border-radius:6px;min-width:70px;text-align:center}
  button{padding:8px 12px;margin:6px;border-radius:6px;border:0;cursor:pointer}
  #talk{background:#c33;color:#fff}
  #mode{background:#2563eb;color:#fff}
  #log{background:#000;padding:8px;height:220px;overflow:auto;border-radius:6px;margin-top:8px;font-family:monospace;font-size:12px}
  #peerId{background:#222;padding:6px;border-radius:6px;margin-left:8px}
  input[type=text]{padding:6px;border-radius:6px;border:1px solid #333;background:#111;color:#eee}
  .small{font-size:0.9rem;color:#bbb}
  .bg-radio{background-image:url('https://upload.wikimedia.org/wikipedia/commons/7/73/Walkie_talkie_icon.png');background-repeat:no-repeat;background-position:center;background-size:200px;opacity:0.06;position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<div class="bg-radio"></div>

<div class="header">
  <div>
    <h2 style="margin:0">Walkie Talkie ‚Äî Canal <span id="canal">100</span></h2>
    <div class="small">Canais: 100 ‚Üí 199</div>
  </div>
  <div style="margin-left:auto;display:flex;align-items:center">
    <div>ID: <span id="peerId">conectando...</span></div>
  </div>
</div>

<div style="margin-top:8px">
  <button onclick="mudarCanal(-1)">‚¨ÖÔ∏è</button>
  <button onclick="mudarCanal(1)">‚û°Ô∏è</button>

  <button id="mode" onclick="toggleMode()">Modo: Walkie</button>
  <button id="talk">üìª Pressione para falar</button>

  <span style="margin-left:12px">Manual ID: <input id="manualId" type="text" placeholder="cole outro ID" /> <button onclick="callManual()">Call manual</button></span>
</div>

<div style="margin-top:8px">
  <button onclick="startLocalMic()">Start mic (liga modo cont√≠nuo)</button>
  <button onclick="stopLocalMic()">Stop mic</button>
</div>

<div id="log"></div>

<audio id="remoteAudio" playsinline autoplay></audio>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
/* ====== CONFIG ====== */
const PEER_HOST = 'peerjs-server.onrender.com'; // servidor que eu te passei
const PEER_PORT = 443;
const PEER_PATH = '/peerjs';
/* ==================== */

let canal = 100;
let modoLig = false; // false = walkie (hold), true = liga√ß√£o (cont√≠nuo)
let peer = null;
let localStream = null;
let logEl = document.getElementById('log');
let remoteAudio = document.getElementById('remoteAudio');
let beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

function log(...args){
  const line = '['+new Date().toLocaleTimeString()+'] '+ args.map(a => (typeof a==='object' ? JSON.stringify(a) : a)).join(' ');
  logEl.innerText = line + '\\n' + logEl.innerText;
}
function setPeerIdText(t){ document.getElementById('peerId').innerText = t; }
function setCanalText(){ document.getElementById('canal').innerText = canal; }

/* Create Peer */
function startPeer(){
  try {
    peer = new Peer(`canal-${canal}-${Math.floor(Math.random()*100000)}`, {
      host: PEER_HOST, port: PEER_PORT, path: PEER_PATH, secure: true
    });
  } catch(e){ log('Erro criando Peer:', e); return; }

  peer.on('open', id => {
    log('Peer aberto:', id);
    setPeerIdText(id);
    // se j√° estivermos com microfone (modo liga√ß√£o) tentar listar e conectar
    if (modoLig && !localStream) startLocalMic();
    attemptListAndConnect();
  });

  peer.on('error', err => {
    log('Peer error:', err && err.message ? err.message : err);
  });

  peer.on('call', async call => {
    log('Recebeu chamada de', call.peer);
    try {
      // responder com nosso microfone (se j√° temos stream use, sen√£o pe√ßa)
      if(!localStream){
        localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        log('Microfone local obtido para responder chamada');
      }
      call.answer(localStream);
      call.on('stream', remoteStream => {
        log('Recebendo stream remoto de', call.peer);
        playRemote(remoteStream);
      });
    } catch(err){
      log('Erro ao responder chamada:', err);
    }
  });
}

/* listAllPeers + conectar aos do canal */
async function attemptListAndConnect(){
  if(!peer || !peer.listAllPeers) { log('listAllPeers indispon√≠vel no servidor'); return; }
  try {
    const peers = await peer.listAllPeers();
    log('Peers no servidor:', peers.length);
    peers.forEach(pid => {
      if(pid.startsWith('canal-'+canal) && pid !== peer.id){
        log('Encontrado peer no canal:', pid);
        // Se estamos em modo liga√ß√£o ou temos streamLocal, chamamos
        if(localStream){
          callPeer(pid, localStream);
        } else if(modoLig){
          await startLocalMic();
          if(localStream) callPeer(pid, localStream);
        } else {
          // modo walkie: chamar s√≥ quando pressionar bot√£o
        }
      }
    });
  } catch(err){
    log('Erro em listAllPeers:', err && err.message ? err.message : err);
  }
}

/* Faz a chamada a um peer com um stream */
function callPeer(targetId, stream){
  try{
    const call = peer.call(targetId, stream);
    call.on('stream', rs => {
      log('Stream recebido ap√≥s chamar', targetId);
      playRemote(rs);
    });
    call.on('error', e => log('Call error:', e));
  } catch(e){
    log('Erro ao chamar', e);
  }
}

/* comando manual usado para teste */
async function callManual(){
  const id = document.getElementById('manualId').value.trim();
  if(!id){ alert('Cole um ID'); return; }
  try {
    if(!localStream) {
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      log('Microfone local obtido (manual)');
    }
    callPeer(id, localStream);
    log('Chamada manual iniciada para', id);
  } catch(err){
    log('Erro callManual:', err);
  }
}

/* play remoto */
function playRemote(stream){
  try{
    remoteAudio.srcObject = stream;
    // tentar tocar (alguns navegadores exigem intera√ß√£o do usu√°rio)
    remoteAudio.play().catch(e => log('remoteAudio.play() bloqueado:', e));
  }catch(e){ log('Erro playRemote', e); }
}

/* start/stop mic local */
async function startLocalMic(){
  if(localStream) { log('J√° tem microfone local'); return localStream; }
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    log('Microfone ativado localmente');
    attemptListAndConnect();
    return localStream;
  } catch(err){
    log('Falha ao acessar microfone:', err);
  }
}
function stopLocalMic(){
  if(localStream){
    localStream.getTracks().forEach(t=> t.stop());
    localStream = null;
    log('Microfone local parado');
  } else log('Nenhum microfone ativo');
}

/* canais */
function mudarCanal(delta){
  canal += delta;
  if(canal < 100) canal = 199;
  if(canal > 199) canal = 100;
  setCanalText();
  // reiniciar peer no novo canal
  try { if(peer) peer.destroy(); } catch(e){/*ignore*/}
  startPeer();
}

/* modos e bot√£o talk */
function toggleMode(){
  modoLig = !modoLig;
  document.getElementById('mode').innerText = 'Modo: ' + (modoLig ? 'Liga√ß√£o' : 'Walkie');
  log('Modo alterado:', modoLig ? 'Liga√ß√£o (cont√≠nuo)' : 'Walkie (segurar)');
  if(modoLig) startLocalMic();
}
let talkBtn = document.getElementById('talk');
talkBtn.addEventListener('mousedown', onTalkStart);
talkBtn.addEventListener('mouseup', onTalkEnd);
talkBtn.addEventListener('touchstart', onTalkStart);
talkBtn.addEventListener('touchend', onTalkEnd);

async function onTalkStart(e){
  e.preventDefault();
  log('Pressionou falar');
  if(!modoLig) beep.play().catch(()=>log('beep bloqueado'));
  try {
    if(!localStream){
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      log('Microfone local obtido (talk start)');
    }
    // conectar a peers encontrados
    if(peer && peer.listAllPeers){
      const peers = await peer.listAllPeers();
      for(const pid of peers){
        if(pid.startsWith('canal-'+canal) && pid !== peer.id){
          callPeer(pid, localStream);
        }
      }
    } else {
      log('listAllPeers indispon√≠vel ‚Äî modo manual necess√°rio');
    }
  } catch(err){
    log('Erro ao iniciar transmiss√£o:', err);
  }
}
function onTalkEnd(e){
  e.preventDefault();
  log('Soltou falar');
  if(!modoLig && localStream){
    stopLocalMic();
  }
}

/* inicializa */
setCanalText();
startPeer();
log('P√°gina carregada ‚Äî aguarde o Peer abrir e leia o log.');
</script>
</body>
</html>
